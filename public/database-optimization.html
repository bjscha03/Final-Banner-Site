<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Database Optimization - Money Handling & User Association</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #28a745; font-size: 2.2em; margin: 0; }
        .header p { color: #666; font-size: 1.1em; margin: 10px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .migration { margin: 25px 0; padding: 25px; border: 2px solid #28a745; border-radius: 8px; background: #f8fff9; }
        .migration h3 { margin-top: 0; color: #28a745; font-size: 1.3em; }
        .migration p { color: #666; margin: 10px 0; }
        .migration ul { color: #666; margin: 10px 0; }
        .migration li { margin: 5px 0; }
        button { 
            padding: 12px 25px; margin: 8px; background: #28a745; color: white; 
            border: none; border-radius: 5px; cursor: pointer; font-size: 1em;
            transition: background 0.3s;
        }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .test-button { background: #007bff; }
        .test-button:hover { background: #0056b3; }
        .results { 
            margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; 
            white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status { padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center; font-weight: bold; }
        .status.ready { background: #d4edda; color: #155724; }
        .status.working { background: #fff3cd; color: #856404; }
        .status.complete { background: #cce5ff; color: #004085; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ DATABASE OPTIMIZATION</h1>
            <p><strong>Money Handling & User-Order Association Enhancement</strong></p>
            <p>Optimize the working system without breaking existing functionality</p>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> Your order system is currently working! These optimizations will enhance performance and money handling while preserving all existing functionality. Each step is reversible and safe.
        </div>

        <div class="migration">
            <h3>üîç Step 1: Pre-Migration Validation</h3>
            <p>Verify current system state and ensure it's safe to proceed with optimizations.</p>
            <ul>
                <li>Check existing order data integrity</li>
                <li>Validate user-order associations</li>
                <li>Confirm money values are consistent</li>
            </ul>
            <button onclick="runValidation()" id="validation-btn">üîç Run Pre-Migration Validation</button>
            <div id="validation-results" class="results"></div>
        </div>

        <div class="migration">
            <h3>üí∞ Step 2: Money Handling Optimization</h3>
            <p>Add generated dollar columns for UI consumption while keeping precise cents storage.</p>
            <ul>
                <li>Add computed dollar columns (subtotal, tax, total)</li>
                <li>Create orders_read view for frontend queries</li>
                <li>Maintain existing cents-based write operations</li>
            </ul>
            <button onclick="runMigration('money-optimization')" id="money-btn" disabled>üí∞ Optimize Money Handling</button>
            <div id="money-optimization-results" class="results"></div>
        </div>

        <div class="migration">
            <h3>üë• Step 3: User-Order Association Enhancement</h3>
            <p>Backfill missing user associations and add consistency safeguards.</p>
            <ul>
                <li>Associate existing orders with users where email matches</li>
                <li>Add performance indexes for My Orders queries</li>
                <li>Preserve guest checkout functionality</li>
            </ul>
            <button onclick="runMigration('user-association')" id="user-btn" disabled>üë• Enhance User Associations</button>
            <div id="user-association-results" class="results"></div>
        </div>

        <div class="migration">
            <h3>‚ö° Step 4: Performance Optimization</h3>
            <p>Add indexes and optimizations for faster queries.</p>
            <ul>
                <li>Create indexes for My Orders page performance</li>
                <li>Optimize order lookup queries</li>
                <li>Add database constraints for data integrity</li>
            </ul>
            <button onclick="runMigration('performance')" id="performance-btn" disabled>‚ö° Optimize Performance</button>
            <div id="performance-results" class="results"></div>
        </div>

        <div class="grid">
            <div class="migration">
                <h3>‚úÖ Step 5: Verification</h3>
                <p>Test all optimizations work correctly.</p>
                <button class="test-button" onclick="runVerification()" id="verify-btn" disabled>‚úÖ Verify Optimizations</button>
                <div id="verification-results" class="results"></div>
            </div>

            <div class="migration">
                <h3>üîÑ Rollback (If Needed)</h3>
                <p>Safely revert changes if issues occur.</p>
                <button onclick="runRollback()" id="rollback-btn" disabled style="background: #dc3545;">üîÑ Rollback Changes</button>
                <div id="rollback-results" class="results"></div>
            </div>
        </div>

        <div id="overall-status" class="status ready">
            <strong>Status:</strong> Ready to begin optimization process
        </div>
    </div>

    <script>
        let validationComplete = false;
        let migrationsComplete = { money: false, user: false, performance: false };

        async function runValidation() {
            const btn = document.getElementById('validation-btn');
            const results = document.getElementById('validation-results');
            const status = document.getElementById('overall-status');
            
            btn.disabled = true;
            btn.textContent = 'üîç Validating...';
            results.textContent = 'Running pre-migration validation...\n';
            results.className = 'results info';
            status.textContent = 'Status: Running validation checks...';
            status.className = 'status working';

            try {
                const response = await fetch('/.netlify/functions/database-optimization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: 'validation' })
                });

                const data = await response.json();

                if (data.success) {
                    results.textContent = `‚úÖ VALIDATION PASSED!\n\n${JSON.stringify(data.result, null, 2)}`;
                    results.className = 'results success';
                    btn.textContent = '‚úÖ Validation Complete';
                    validationComplete = true;
                    
                    // Enable next step
                    document.getElementById('money-btn').disabled = false;
                    status.textContent = 'Status: Validation complete - Ready for optimization';
                    status.className = 'status ready';
                } else {
                    results.textContent = `‚ùå VALIDATION FAILED:\n${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                    btn.textContent = '‚ùå Validation Failed - Retry';
                    btn.disabled = false;
                    status.textContent = 'Status: Validation failed - Check results';
                    status.className = 'status ready';
                }
            } catch (error) {
                results.textContent = `‚ùå VALIDATION ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå Error - Retry';
                btn.disabled = false;
                status.textContent = 'Status: Validation error - Check connection';
                status.className = 'status ready';
            }
        }

        async function runMigration(migrationName) {
            const btn = document.getElementById(`${migrationName === 'money-optimization' ? 'money' : migrationName === 'user-association' ? 'user' : 'performance'}-btn`);
            const results = document.getElementById(`${migrationName}-results`);
            const status = document.getElementById('overall-status');
            
            btn.disabled = true;
            btn.textContent = `üîÑ Running ${migrationName}...`;
            results.textContent = `Running ${migrationName} migration...\n`;
            results.className = 'results info';
            status.textContent = `Status: Running ${migrationName} optimization...`;
            status.className = 'status working';

            try {
                const response = await fetch('/.netlify/functions/database-optimization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: migrationName })
                });

                const data = await response.json();

                if (data.success) {
                    results.textContent = `‚úÖ ${migrationName.toUpperCase()} COMPLETED!\n\n${JSON.stringify(data.result, null, 2)}`;
                    results.className = 'results success';
                    btn.textContent = `‚úÖ ${migrationName} Complete`;
                    
                    // Mark as complete and enable next step
                    if (migrationName === 'money-optimization') {
                        migrationsComplete.money = true;
                        document.getElementById('user-btn').disabled = false;
                    } else if (migrationName === 'user-association') {
                        migrationsComplete.user = true;
                        document.getElementById('performance-btn').disabled = false;
                    } else if (migrationName === 'performance') {
                        migrationsComplete.performance = true;
                        document.getElementById('verify-btn').disabled = false;
                        document.getElementById('rollback-btn').disabled = false;
                    }
                    
                    status.textContent = `Status: ${migrationName} completed successfully`;
                    status.className = 'status ready';
                } else {
                    results.textContent = `‚ùå ${migrationName.toUpperCase()} FAILED:\n${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                    btn.textContent = `‚ùå ${migrationName} Failed - Retry`;
                    btn.disabled = false;
                    status.textContent = `Status: ${migrationName} failed - Check results`;
                    status.className = 'status ready';
                }
            } catch (error) {
                results.textContent = `‚ùå ${migrationName.toUpperCase()} ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = `‚ùå Error - Retry`;
                btn.disabled = false;
                status.textContent = `Status: ${migrationName} error - Check connection`;
                status.className = 'status ready';
            }
        }

        async function runVerification() {
            const btn = document.getElementById('verify-btn');
            const results = document.getElementById('verification-results');
            const status = document.getElementById('overall-status');
            
            btn.disabled = true;
            btn.textContent = '‚úÖ Verifying...';
            results.textContent = 'Running post-migration verification...\n';
            results.className = 'results info';
            status.textContent = 'Status: Verifying all optimizations...';
            status.className = 'status working';

            try {
                const response = await fetch('/.netlify/functions/database-optimization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: 'verification' })
                });

                const data = await response.json();

                if (data.success) {
                    results.textContent = `üéâ ALL OPTIMIZATIONS VERIFIED!\n\n${JSON.stringify(data.result, null, 2)}`;
                    results.className = 'results success';
                    btn.textContent = 'üéâ Verification Complete';
                    status.textContent = 'Status: All optimizations completed successfully!';
                    status.className = 'status complete';
                } else {
                    results.textContent = `‚ùå VERIFICATION FAILED:\n${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                    btn.textContent = '‚ùå Verification Failed';
                    status.textContent = 'Status: Verification failed - Consider rollback';
                    status.className = 'status ready';
                }
            } catch (error) {
                results.textContent = `‚ùå VERIFICATION ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå Error - Retry';
                btn.disabled = false;
                status.textContent = 'Status: Verification error';
                status.className = 'status ready';
            }
        }

        async function runRollback() {
            if (!confirm('Are you sure you want to rollback all optimizations? This will revert the database to its previous state.')) {
                return;
            }

            const btn = document.getElementById('rollback-btn');
            const results = document.getElementById('rollback-results');
            const status = document.getElementById('overall-status');
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Rolling back...';
            results.textContent = 'Rolling back all optimizations...\n';
            results.className = 'results info';
            status.textContent = 'Status: Rolling back changes...';
            status.className = 'status working';

            try {
                const response = await fetch('/.netlify/functions/database-optimization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operation: 'rollback' })
                });

                const data = await response.json();

                if (data.success) {
                    results.textContent = `‚úÖ ROLLBACK COMPLETED!\n\n${JSON.stringify(data.result, null, 2)}`;
                    results.className = 'results success';
                    btn.textContent = '‚úÖ Rollback Complete';
                    status.textContent = 'Status: Rollback completed - System restored';
                    status.className = 'status ready';
                } else {
                    results.textContent = `‚ùå ROLLBACK FAILED:\n${data.error}\n\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                    btn.textContent = '‚ùå Rollback Failed';
                    status.textContent = 'Status: Rollback failed - Manual intervention may be needed';
                    status.className = 'status ready';
                }
            } catch (error) {
                results.textContent = `‚ùå ROLLBACK ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå Error';
                status.textContent = 'Status: Rollback error';
                status.className = 'status ready';
            }
        }
    </script>
</body>
</html>
