<!DOCTYPE html>
<html>
<head>
    <title>Database Migration - Add Username Column</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success { color: green; background: #f0f8f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: red; background: #fff0f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: blue; background: #f0f0ff; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Database Migration: Add Username Column</h1>
        
        <div class="info">
            <strong>Purpose:</strong> This will add the username column to the profiles table so user registration works properly.
        </div>

        <div id="status"></div>

        <button id="runMigration" onclick="runMigration()">
            Run Database Migration
        </button>

        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = typeof message === 'object' ? '<pre>' + JSON.stringify(message, null, 2) + '</pre>' : message;
            results.appendChild(div);
            console.log(message);
        }

        async function runMigration() {
            const button = document.getElementById('runMigration');
            const status = document.getElementById('status');
            
            button.disabled = true;
            button.textContent = 'Running Migration...';
            status.innerHTML = '<div class="info">‚è≥ Running database migration...</div>';

            try {
                log('üîç Starting database migration...', 'info');
                
                const response = await fetch('/.netlify/functions/migrate-database', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.status === 'already_migrated') {
                        log('‚úÖ Username column already exists - no migration needed', 'success');
                        status.innerHTML = '<div class="success">‚úÖ Migration not needed - username column already exists</div>';
                    } else {
                        log('‚úÖ Database migration completed successfully!', 'success');
                        log('Migration result:', 'info');
                        log(result, 'info');
                        status.innerHTML = '<div class="success">‚úÖ Migration completed successfully!</div>';
                    }
                    
                    log('üéØ You can now test user registration with username field', 'success');
                    
                } else {
                    log('‚ùå Migration failed: ' + result.error, 'error');
                    log('Details: ' + result.details, 'error');
                    status.innerHTML = '<div class="error">‚ùå Migration failed - see details below</div>';
                }

            } catch (error) {
                log('‚ùå Error running migration: ' + error.message, 'error');
                status.innerHTML = '<div class="error">‚ùå Error running migration</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'Run Database Migration';
            }
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            log('üîç Database Migration Tool Loaded', 'info');
            log('Click the button above to add the username column to the profiles table', 'info');
        });
    </script>
</body>
</html>
