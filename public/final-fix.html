<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß FINAL FIX - User & Order Issues</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #dc3545; font-size: 2.5em; margin: 0; }
        .header p { color: #666; font-size: 1.2em; margin: 10px 0; }
        .fix-section { margin: 30px 0; padding: 20px; border: 2px solid #dc3545; border-radius: 8px; background: #fff5f5; }
        .fix-section h2 { color: #dc3545; margin-top: 0; }
        .fix-button { 
            background: #dc3545; color: white; border: none; padding: 15px 30px; 
            font-size: 1.2em; border-radius: 5px; cursor: pointer; width: 100%; 
            margin: 10px 0; transition: background 0.3s;
        }
        .fix-button:hover { background: #c82333; }
        .fix-button:disabled { background: #6c757d; cursor: not-allowed; }
        .results { 
            margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; 
            white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .step { margin: 15px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step h3 { margin-top: 0; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß FINAL FIX</h1>
            <p><strong>This will fix ALL user and order issues once and for all</strong></p>
        </div>

        <div class="fix-section">
            <h2>üö® CRITICAL ISSUES TO FIX:</h2>
            <ul>
                <li><strong>Orders with NULL user_id</strong> - Orders not associated with users</li>
                <li><strong>Missing user profiles</strong> - Users signing in but not in database</li>
                <li><strong>My Orders page 404</strong> - Can't find orders for users</li>
                <li><strong>Guest email instead of real email</strong> - Wrong email in orders</li>
            </ul>
        </div>

        <div class="step">
            <h3>üîß Step 1: Fix All User & Order Issues</h3>
            <p>This will:</p>
            <ul>
                <li>Find all orders with NULL user_id</li>
                <li>Create missing user profiles in database</li>
                <li>Associate orphaned orders with correct users</li>
                <li>Ensure your account (bjscha02@gmail.com) exists</li>
            </ul>
            <button class="fix-button" onclick="fixAllIssues()" id="fix-btn">
                üîß FIX ALL ISSUES NOW
            </button>
            <div id="fix-results" class="results"></div>
        </div>

        <div class="step">
            <h3>‚úÖ Step 2: Verify Fix</h3>
            <p>After running the fix, test these:</p>
            <ul>
                <li><strong>My Orders page</strong> - Should show your orders</li>
                <li><strong>New order creation</strong> - Should work without errors</li>
                <li><strong>Proper email association</strong> - Orders should have real emails</li>
            </ul>
            <button class="fix-button" onclick="verifyFix()" id="verify-btn" disabled>
                ‚úÖ VERIFY FIX WORKED
            </button>
            <div id="verify-results" class="results"></div>
        </div>

        <div class="step">
            <h3>üéØ Step 3: Test Complete Flow</h3>
            <p>Final verification:</p>
            <button class="fix-button" onclick="testCompleteFlow()" id="test-btn" disabled>
                üéØ TEST COMPLETE FLOW
            </button>
            <div id="test-results" class="results"></div>
        </div>
    </div>

    <script>
        let fixCompleted = false;

        async function fixAllIssues() {
            const btn = document.getElementById('fix-btn');
            const results = document.getElementById('fix-results');
            
            btn.disabled = true;
            btn.textContent = 'üîß FIXING ISSUES...';
            results.textContent = 'Starting comprehensive fix...\n';
            results.className = 'results warning';

            try {
                const response = await fetch('/.netlify/functions/fix-all-user-issues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    results.textContent = `‚úÖ ALL ISSUES FIXED SUCCESSFULLY!\n\n${JSON.stringify(data.results, null, 2)}`;
                    results.className = 'results success';
                    btn.textContent = '‚úÖ ISSUES FIXED!';
                    
                    // Enable next step
                    document.getElementById('verify-btn').disabled = false;
                    fixCompleted = true;
                } else {
                    results.textContent = `‚ùå FIX FAILED:\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                    btn.textContent = '‚ùå FIX FAILED';
                    btn.disabled = false;
                }
            } catch (error) {
                results.textContent = `‚ùå ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå ERROR - TRY AGAIN';
                btn.disabled = false;
            }
        }

        async function verifyFix() {
            const btn = document.getElementById('verify-btn');
            const results = document.getElementById('verify-results');
            
            btn.disabled = true;
            btn.textContent = '‚úÖ VERIFYING...';
            results.textContent = 'Verifying fix worked...\n';
            results.className = 'results warning';

            try {
                // Check orders
                const ordersResponse = await fetch('/.netlify/functions/debug-orders');
                const ordersData = await ordersResponse.json();

                let verificationResults = 'VERIFICATION RESULTS:\n\n';
                
                if (ordersData.users && ordersData.users.length > 0) {
                    verificationResults += `‚úÖ Users in database: ${ordersData.users.length}\n`;
                    const yourUser = ordersData.users.find(u => u.email === 'bjscha02@gmail.com');
                    if (yourUser) {
                        verificationResults += `‚úÖ Your account found: ${yourUser.id}\n`;
                    } else {
                        verificationResults += `‚ùå Your account not found\n`;
                    }
                } else {
                    verificationResults += `‚ùå No users found in database\n`;
                }

                if (ordersData.orders && ordersData.orders.length > 0) {
                    verificationResults += `‚úÖ Orders in database: ${ordersData.orders.length}\n`;
                    const ordersWithUsers = ordersData.orders.filter(o => o.user_id !== null);
                    verificationResults += `‚úÖ Orders with user_id: ${ordersWithUsers.length}\n`;
                    const orphanedOrders = ordersData.orders.filter(o => o.user_id === null);
                    if (orphanedOrders.length > 0) {
                        verificationResults += `‚ùå Still orphaned orders: ${orphanedOrders.length}\n`;
                    } else {
                        verificationResults += `‚úÖ No orphaned orders remaining\n`;
                    }
                } else {
                    verificationResults += `‚ùå No orders found in database\n`;
                }

                verificationResults += `\nFull data:\n${JSON.stringify(ordersData, null, 2)}`;

                results.textContent = verificationResults;
                results.className = 'results success';
                btn.textContent = '‚úÖ VERIFICATION COMPLETE';
                
                // Enable final test
                document.getElementById('test-btn').disabled = false;

            } catch (error) {
                results.textContent = `‚ùå VERIFICATION ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå VERIFICATION FAILED';
                btn.disabled = false;
            }
        }

        async function testCompleteFlow() {
            const btn = document.getElementById('test-btn');
            const results = document.getElementById('test-results');
            
            btn.disabled = true;
            btn.textContent = 'üéØ TESTING...';
            results.textContent = 'Testing complete flow...\n';
            results.className = 'results warning';

            try {
                let testResults = 'COMPLETE FLOW TEST:\n\n';

                // Test 1: My Orders page
                testResults += '1. Testing My Orders page access...\n';
                try {
                    const myOrdersResponse = await fetch('/my-orders');
                    if (myOrdersResponse.ok || myOrdersResponse.status === 200) {
                        testResults += '   ‚úÖ My Orders page accessible\n';
                    } else {
                        testResults += `   ‚ùå My Orders page error: ${myOrdersResponse.status}\n`;
                    }
                } catch (e) {
                    testResults += `   ‚ùå My Orders page error: ${e.message}\n`;
                }

                // Test 2: Order creation
                testResults += '\n2. Testing order creation...\n';
                // This would require more complex setup, so just indicate next steps
                testResults += '   ‚û°Ô∏è Next: Try creating a real order through checkout\n';
                testResults += '   ‚û°Ô∏è Next: Check My Orders page shows your orders\n';

                testResults += '\nüéâ BASIC TESTS COMPLETE!\n';
                testResults += '\nNEXT STEPS:\n';
                testResults += '1. Go to https://bannersonthefly.com/my-orders\n';
                testResults += '2. Sign in if needed\n';
                testResults += '3. Check if your orders appear\n';
                testResults += '4. Try creating a new order\n';
                testResults += '5. Verify new order appears in My Orders\n';

                results.textContent = testResults;
                results.className = 'results success';
                btn.textContent = 'üéâ TESTING COMPLETE!';

            } catch (error) {
                results.textContent = `‚ùå TEST ERROR: ${error.message}`;
                results.className = 'results error';
                btn.textContent = '‚ùå TEST FAILED';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
