<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Complete Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .results { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üß™ Complete Flow Test - Final Verification</h1>
    
    <div class="test-section info">
        <h3>üìã Test Plan</h3>
        <p>This will test the complete order flow to ensure everything is working:</p>
        <ol>
            <li><strong>Database Connection</strong> - Verify Netlify functions can connect</li>
            <li><strong>User Authentication</strong> - Check current user status</li>
            <li><strong>Order Creation</strong> - Test creating a new order</li>
            <li><strong>Order Retrieval</strong> - Test fetching orders for user</li>
            <li><strong>Complete Flow</strong> - End-to-end test</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>üîå Step 1: Database Connection</h3>
        <button onclick="testDatabaseConnection()">Test Database Connection</button>
        <div id="db-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üë§ Step 2: User Authentication</h3>
        <button onclick="testUserAuth()">Check Current User</button>
        <div id="auth-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üì¶ Step 3: Order Creation</h3>
        <button onclick="testOrderCreation()">Create Test Order</button>
        <div id="order-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üìã Step 4: Order Retrieval</h3>
        <button onclick="testOrderRetrieval()">Fetch My Orders</button>
        <div id="retrieval-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üöÄ Step 5: Complete Flow Test</h3>
        <button onclick="runCompleteTest()">Run Complete Test</button>
        <div id="complete-results" class="results"></div>
    </div>

    <script>
        let currentUser = null;
        let testOrderId = null;

        async function testDatabaseConnection() {
            const results = document.getElementById('db-results');
            results.textContent = 'Testing database connection...';
            
            try {
                const response = await fetch('/.netlify/functions/debug-env');
                const data = await response.json();
                
                if (response.ok) {
                    results.textContent = `‚úÖ Database Connection: ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = `‚ùå Database Connection Failed: ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå Database Connection Error: ${error.message}`;
                results.className = 'results error';
            }
        }

        async function testUserAuth() {
            const results = document.getElementById('auth-results');
            results.textContent = 'Checking user authentication...';
            
            try {
                // Simulate getting current user (you'll need to implement this based on your auth system)
                const response = await fetch('/.netlify/functions/debug-orders');
                const data = await response.json();
                
                if (response.ok && data.users && data.users.length > 0) {
                    currentUser = data.users.find(u => u.email === 'bjscha02@gmail.com') || data.users[0];
                    results.textContent = `‚úÖ Current User: ${JSON.stringify(currentUser, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = `‚ùå User Auth Failed: ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå User Auth Error: ${error.message}`;
                results.className = 'results error';
            }
        }

        async function testOrderCreation() {
            const results = document.getElementById('order-results');
            results.textContent = 'Creating test order...';
            
            if (!currentUser) {
                results.textContent = '‚ùå Please run User Authentication test first';
                results.className = 'results error';
                return;
            }
            
            try {
                const testOrder = {
                    user_id: currentUser.id,
                    subtotal_cents: 2400,
                    tax_cents: 144,
                    total_cents: 2544,
                    currency: 'usd',
                    items: [{
                        width_in: 24,
                        height_in: 36,
                        quantity: 1,
                        material: '13oz',
                        grommets: 'corners',
                        rope_feet: 0,
                        area_sqft: 6.0,
                        unit_price_cents: 2400,
                        line_total_cents: 2400
                    }]
                };

                const response = await fetch('/.netlify/functions/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testOrder)
                });

                const data = await response.json();
                
                if (response.ok) {
                    testOrderId = data.id;
                    results.textContent = `‚úÖ Order Created Successfully: ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = `‚ùå Order Creation Failed: ${response.status} - ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå Order Creation Error: ${error.message}`;
                results.className = 'results error';
            }
        }

        async function testOrderRetrieval() {
            const results = document.getElementById('retrieval-results');
            results.textContent = 'Fetching orders...';
            
            if (!currentUser) {
                results.textContent = '‚ùå Please run User Authentication test first';
                results.className = 'results error';
                return;
            }
            
            try {
                const response = await fetch(`/.netlify/functions/get-orders?user_id=${currentUser.id}`);
                const data = await response.json();
                
                if (response.ok) {
                    results.textContent = `‚úÖ Orders Retrieved: ${data.length} orders found\n${JSON.stringify(data, null, 2)}`;
                    results.className = 'results success';
                } else {
                    results.textContent = `‚ùå Order Retrieval Failed: ${response.status} - ${JSON.stringify(data, null, 2)}`;
                    results.className = 'results error';
                }
            } catch (error) {
                results.textContent = `‚ùå Order Retrieval Error: ${error.message}`;
                results.className = 'results error';
            }
        }

        async function runCompleteTest() {
            const results = document.getElementById('complete-results');
            results.textContent = 'Running complete flow test...\n';
            results.className = 'results info';
            
            const steps = [
                { name: 'Database Connection', func: testDatabaseConnection },
                { name: 'User Authentication', func: testUserAuth },
                { name: 'Order Creation', func: testOrderCreation },
                { name: 'Order Retrieval', func: testOrderRetrieval }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                results.textContent += `\n${i + 1}. Testing ${step.name}...`;
                
                try {
                    await step.func();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second between tests
                    results.textContent += ` ‚úÖ`;
                } catch (error) {
                    results.textContent += ` ‚ùå ${error.message}`;
                    results.className = 'results error';
                    return;
                }
            }
            
            results.textContent += '\n\nüéâ ALL TESTS COMPLETED! Check individual sections for details.';
            results.className = 'results success';
        }
    </script>
</body>
</html>
